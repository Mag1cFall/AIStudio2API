<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Studio 控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/i18n.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'Consolas', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background-color: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #484f58; }
        .log-entry:hover { background-color: #161b22; }
        .prose { color: #c9d1d9; max-width: none; }
        .prose pre { background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 1em; overflow-x: auto; margin: 0.5em 0; }
        .prose code { font-family: 'JetBrains Mono', Consolas, monospace; font-size: 0.9em; background-color: rgba(110, 118, 129, 0.4); padding: 0.2em 0.4em; border-radius: 4px; }
        .prose pre code { background-color: transparent; padding: 0; border-radius: 0; color: inherit; }
        .prose p { margin: 0.5em 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin: 0.5em 0; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin: 0.5em 0; }
        .prose a { color: #58a6ff; text-decoration: none; }
        .prose a:hover { text-decoration: underline; }
        .prose blockquote { border-left: 4px solid #30363d; padding-left: 1em; color: #8b949e; margin: 0.5em 0; }
        .prose h1, .prose h2, .prose h3 { color: #fff; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; }
        .prose h1 { font-size: 1.5em; border-bottom: 1px solid #30363d; padding-bottom: 0.3em; }
        .prose h2 { font-size: 1.3em; }
        .prose h3 { font-size: 1.1em; }
        .log-action-required {
            border-color: #f59e0b !important;
            background-color: rgba(245, 158, 11, 0.1);
            color: #fcd34d;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm">
    <div id="app" class="flex w-full h-full">
        <!-- Main UI -->
        <div class="w-64 bg-[#161b22] flex flex-col border-r border-[#30363d] shrink-0">
            <div class="h-14 flex items-center px-4 border-b border-[#30363d] gap-2 justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" :class="statusColor"></div>
                    <h1 class="font-bold text-lg text-white">AI Studio Proxy</h1>
                </div>
                <div class="relative group">
                    <button class="text-xs text-gray-500 hover:text-white border border-gray-700 rounded px-1.5 py-0.5 transition font-mono flex items-center gap-1">
                        {{ lang }}
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <!-- 使用 pt-1 增加透明填充区以桥接间隙，防止鼠标移动时菜单消失 -->
                    <div class="absolute right-0 top-full pt-1 hidden group-hover:block z-50">
                        <div class="bg-[#161b22] border border-[#30363d] rounded shadow-xl overflow-hidden">
                            <button v-for="l in availableLangs" :key="l.code" @click="setLang(l.code)"
                                class="block w-full text-left px-4 py-2 text-xs text-gray-300 hover:bg-blue-600 hover:text-white whitespace-nowrap">
                                {{ l.label }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-2 space-y-1">
                <button @click="currentTab = 'dashboard'" 
                    :class="['w-full text-left px-3 py-2 rounded-md transition flex items-center gap-2', currentTab === 'dashboard' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#21262d]']">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    {{ t('nav.dashboard') }}
                </button>
                <button @click="currentTab = 'config'" 
                    :class="['w-full text-left px-3 py-2 rounded-md transition flex items-center gap-2', currentTab === 'config' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#21262d]']">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    {{ t('nav.config') }}
                </button>
                <button @click="currentTab = 'auth'" 
                    :class="['w-full text-left px-3 py-2 rounded-md transition flex items-center gap-2', currentTab === 'auth' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#21262d]']">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                    {{ t('nav.auth') }}
                </button>
                <button @click="currentTab = 'system'"
                    :class="['w-full text-left px-3 py-2 rounded-md transition flex items-center gap-2', currentTab === 'system' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#21262d]']">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    {{ t('nav.system') }}
                </button>
                <button @click="currentTab = 'playground'"
                    :class="['w-full text-left px-3 py-2 rounded-md transition flex items-center gap-2', currentTab === 'playground' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white hover:bg-[#21262d]']">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    {{ t('nav.playground') }}
                </button>
            </nav>

            <div class="p-4 border-t border-[#30363d]">
                <div class="text-xs text-gray-500 mb-2">{{ t('status.title') }}</div>
                <div class="flex items-center justify-between mb-4">
                    <span :class="statusTextColor" class="font-mono font-bold">{{ serviceStatus.toUpperCase() }}</span>
                    <span v-if="serviceInfo.pid" class="text-xs text-gray-500 font-mono">PID: {{ serviceInfo.pid }}</span>
                </div>
                
                <button v-if="serviceStatus === 'stopped'" @click="startService" :disabled="loading"
                    class="w-full py-2 bg-green-600 hover:bg-green-500 text-white rounded font-bold shadow transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg v-if="loading" class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <svg v-else class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    {{ t('status.start') }}
                </button>
                
                <button v-else @click="stopService" :disabled="loading"
                    class="w-full py-2 bg-red-600 hover:bg-red-500 text-white rounded font-bold shadow transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg v-if="loading" class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <svg v-else class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
                    {{ t('status.stop') }}
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col min-w-0 bg-[#0d1117]">
            <div v-if="currentTab === 'dashboard'" class="flex-1 flex flex-col h-full">
                <div class="h-10 border-b border-[#30363d] flex items-center px-4 justify-between bg-[#161b22]">
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">{{ t('logs.level') }}:</span>
                        <div class="flex bg-[#0d1117] rounded border border-[#30363d] p-0.5">
                            <button @click="logFilter = 'ALL'" :class="['px-2 py-0.5 text-xs rounded transition', logFilter === 'ALL' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-gray-200']">{{ t('logs.all') }}</button>
                            <button @click="logFilter = 'INFO'" :class="['px-2 py-0.5 text-xs rounded transition', logFilter === 'INFO' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-gray-200']">{{ t('logs.info') }}</button>
                            <button @click="logFilter = 'WARN'" :class="['px-2 py-0.5 text-xs rounded transition', logFilter === 'WARN' ? 'bg-yellow-600 text-white' : 'text-gray-400 hover:text-gray-200']">{{ t('logs.warn') }}</button>
                            <button @click="logFilter = 'ERROR'" :class="['px-2 py-0.5 text-xs rounded transition', logFilter === 'ERROR' ? 'bg-red-600 text-white' : 'text-gray-400 hover:text-gray-200']">{{ t('logs.error') }}</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button @click="clearLogs" class="text-gray-400 hover:text-white px-2 py-1 rounded hover:bg-[#30363d]" :title="t('logs.clear')">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <button @click="autoScroll = !autoScroll" :class="['text-xs px-2 py-0.5 rounded border transition', autoScroll ? 'border-blue-500/30 bg-blue-500/10 text-blue-400' : 'border-gray-700 text-gray-500']">
                            {{ t('logs.autoScroll') }}: {{ autoScroll ? 'ON' : 'OFF' }}
                        </button>
                    </div>
                </div>

                <div v-if="isActionRequired" class="p-3 border-b border-amber-500/30 bg-amber-900/10">
                    <div class="text-amber-400 font-bold mb-2 text-center text-sm">
                        <svg class="w-4 h-4 inline-block mr-1 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        {{ t('action.title') }}
                    </div>
                    <div class="flex items-center gap-2">
                        <input v-model="customInput" @keydown.enter="sendInput(customInput)" type="text" :placeholder="t('action.placeholder')"
                            class="flex-1 bg-[#0d1117] border border-[#30363d] rounded px-3 py-1.5 text-white focus:border-blue-500 focus:outline-none transition text-sm">
                        <button @click="sendInput(customInput)" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded font-medium transition text-sm">{{ t('action.send') }}</button>
                    </div>
                    <div class="flex items-center gap-2 mt-2 justify-center flex-wrap">
                        <span class="text-xs text-gray-500">{{ t('action.shortcuts') }}:</span>
                        <button @click="sendInput('')" class="px-3 py-1 bg-[#21262d] hover:bg-[#30363d] text-gray-300 rounded border border-[#30363d] transition text-xs">{{ t('action.sendEnter') }}</button>
                        <button @click="sendInput('N')" class="px-3 py-1 bg-[#21262d] hover:bg-[#30363d] text-gray-300 rounded border border-[#30363d] transition text-xs">{{ t('action.sendN') }}</button>
                        <button @click="sendInput('y')" class="px-3 py-1 bg-[#21262d] hover:bg-[#30363d] text-gray-300 rounded border border-[#30363d] transition text-xs">{{ t('action.sendY') }}</button>
                        <button @click="sendInput('1')" class="px-3 py-1 bg-[#21262d] hover:bg-[#30363d] text-gray-300 rounded border border-[#30363d] transition text-xs">{{ t('action.send1') }}</button>
                        <button @click="sendInput('2')" class="px-3 py-1 bg-[#21262d] hover:bg-[#30363d] text-gray-300 rounded border border-[#30363d] transition text-xs">{{ t('action.send2') }}</button>
                    </div>
                </div>
                
                <div ref="logsContainer" class="flex-1 overflow-auto p-2 font-mono text-[13px] leading-5 bg-[#0d1117]">
                    <div v-for="(log, index) in filteredLogs" :key="index" class="log-entry flex gap-3 px-2 py-0.5 border-l-2"
                        :class="{
                            'border-blue-500 text-gray-300': log.level === 'INFO',
                            'border-yellow-500 text-yellow-100 bg-yellow-500/5': log.level === 'WARN',
                            'border-red-500 text-red-100 bg-red-500/10': log.level === 'ERROR',
                            'log-action-required': log.level === 'ACTION_REQUIRED'
                        }">
                        <span class="text-gray-600 shrink-0 select-none w-16 text-right">{{ log.time }}</span>
                        <span class="whitespace-pre-wrap break-all" :class="{'font-bold': log.level === 'ACTION_REQUIRED'}">{{ log.message }}</span>
                    </div>
                    <div v-if="logs.length === 0" class="text-gray-600 text-center mt-10 italic">{{ t('logs.waiting') }}</div>
                </div>
            </div>

            <div v-if="currentTab === 'config'" class="flex-1 overflow-auto p-8 max-w-3xl mx-auto w-full">
                <h2 class="text-2xl font-bold mb-6 text-white border-b border-[#30363d] pb-2">{{ t('config.title') }}</h2>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">{{ t('config.fastapiPort') }}</label>
                            <input v-model.number="config.fastapi_port" type="number" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition">
                            <p class="text-xs text-gray-600 mt-1">{{ t('config.default') }}: 2048</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">{{ t('config.camoufoxPort') }}</label>
                            <input v-model.number="config.camoufox_debug_port" type="number" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition">
                            <p class="text-xs text-gray-600 mt-1">{{ t('config.default') }}: 9222</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">{{ t('config.launchMode') }}</label>
                        <select v-model="config.launch_mode" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition">
                            <option value="headless">{{ t('config.modeHeadless') }}</option>
                            <option value="debug">{{ t('config.modeDebug') }}</option>
                            <option value="virtual_headless">{{ t('config.modeVirtual') }}</option>
                        </select>
                        <p class="text-xs text-gray-600 mt-1">{{ t('config.modeDesc') }}</p>
                    </div>

                    <div class="bg-[#161b22] p-4 rounded-lg border border-[#30363d]">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-300">{{ t('config.streamProxy') }}</label>
                            <input v-model="config.stream_port_enabled" type="checkbox" class="w-4 h-4 rounded bg-[#0d1117] border-gray-600 text-blue-600 focus:ring-blue-500">
                        </div>
                        <div v-if="config.stream_port_enabled">
                            <label class="block text-xs text-gray-500 mb-1">{{ t('config.streamPort') }}</label>
                            <input v-model.number="config.stream_port" type="number" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition">
                        </div>
                    </div>

                    <div class="bg-[#161b22] p-4 rounded-lg border border-[#30363d]">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-300">{{ t('config.httpProxy') }}</label>
                            <input v-model="config.proxy_enabled" type="checkbox" class="w-4 h-4 rounded bg-[#0d1117] border-gray-600 text-blue-600 focus:ring-blue-500">
                        </div>
                        <div v-if="config.proxy_enabled">
                            <label class="block text-xs text-gray-500 mb-1">{{ t('config.proxyAddress') }}</label>
                            <input v-model="config.proxy_address" type="text" placeholder="http://127.0.0.1:7890" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-3 py-2 text-white focus:border-blue-500 focus:outline-none transition">
                        </div>
                    </div>

                    <div class="flex justify-end pt-4">
                        <button @click="saveConfig" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-medium transition shadow-lg">{{ t('config.save') }}</button>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'auth'" class="flex-1 overflow-auto p-8 max-w-3xl mx-auto w-full">
                <h2 class="text-2xl font-bold mb-6 text-white border-b border-[#30363d] pb-2">{{ t('auth.title') }}</h2>
                
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">{{ t('auth.active') }}</h3>
                    <div v-if="authData.active" class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-500/20 p-2 rounded-full text-green-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <div class="text-green-300 font-mono font-bold text-lg">{{ authData.active }}</div>
                                <div class="text-green-500/60 text-xs">{{ t('auth.using') }}</div>
                            </div>
                        </div>
                        <button @click="deactivateAuth" class="px-3 py-1.5 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded text-xs border border-red-900/50 transition flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            {{ t('auth.deactivate') }}
                        </button>
                    </div>
                    <div v-else class="text-gray-500 italic bg-[#161b22] p-4 rounded border border-[#30363d]">{{ t('auth.noActive') }}</div>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">{{ t('auth.saved') }}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="file in authData.saved" :key="file" class="bg-[#161b22] border border-[#30363d] hover:border-blue-500/50 rounded-lg p-4 transition group">
                            <div class="font-mono text-gray-200 mb-4 truncate" :title="file">{{ file }}</div>
                            <button @click="activateAuth(file)" class="w-full py-1.5 text-xs bg-[#21262d] hover:bg-blue-600 hover:text-white text-gray-300 rounded border border-[#30363d] transition">
                                {{ t('auth.activate') }}
                            </button>
                        </div>
                        <div v-if="authData.saved.length === 0" class="col-span-2 text-center py-8 text-gray-600">
                            {{ t('auth.notFound') }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentTab === 'system'" class="flex-1 overflow-auto p-8 max-w-3xl mx-auto w-full">
                <h2 class="text-2xl font-bold mb-6 text-white border-b border-[#30363d] pb-2">{{ t('system.title') }}</h2>
                
                <div class="space-y-6">
                    <div class="bg-[#161b22] p-4 rounded-lg border border-[#30363d]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-300">{{ t('system.portStatus') }}</h3>
                            <button @click="checkAllPorts" class="px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs transition flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                {{ t('system.refresh') }}
                            </button>
                        </div>
                        
                        <div v-if="multiPortResults.length > 0" class="space-y-4">
                            <div v-for="result in multiPortResults" :key="result.port" class="border border-[#30363d] rounded bg-[#0d1117] overflow-hidden">
                                <div class="px-4 py-2 bg-[#21262d] flex justify-between items-center border-b border-[#30363d]">
                                    <div class="font-medium text-gray-300 flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full" :class="result.in_use ? 'bg-red-500' : 'bg-green-500'"></div>
                                        {{ result.label }} ({{ result.port }})
                                    </div>
                                    <div class="text-xs" :class="result.in_use ? 'text-red-400' : 'text-green-400'">
                                        {{ result.in_use ? t('system.inUse') : t('system.free') }}
                                    </div>
                                </div>
                                <div v-if="result.in_use" class="p-2 space-y-1">
                                    <div v-for="proc in result.processes" :key="proc.pid" class="flex items-center justify-between p-2 hover:bg-[#161b22] rounded transition">
                                        <div class="font-mono text-gray-400 text-xs">
                                            <span class="text-blue-400 font-bold">{{ proc.pid }}</span>
                                            <span class="text-gray-600 mx-2">-</span>
                                            {{ proc.name }}
                                        </div>
                                        <button @click="killProcess(proc.pid)" class="px-2 py-0.5 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded text-xs border border-red-900/50 transition">
                                            {{ t('system.kill') }}
                                        </button>
                                    </div>
                                </div>
                                <div v-else class="p-4 text-center text-gray-600 text-xs italic">
                                    {{ t('system.portFree') }}
                                </div>
                            </div>
                        </div>
                        <div v-else class="text-center py-8 text-gray-500">
                            {{ t('system.refreshHint') }}
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentTab === 'playground'" class="flex-1 flex overflow-hidden">
                <div class="flex-1 flex flex-col min-w-0 bg-[#0d1117]">
                    <div class="flex-1 overflow-auto p-4 space-y-4" ref="chatContainer">
                        <div v-if="chatMessages.length === 0" class="h-full flex flex-col items-center justify-center text-gray-500">
                            <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <p>{{ t('chat.start') }}</p>
                        </div>
                        <div v-for="(msg, idx) in chatMessages" :key="idx" class="flex gap-4 max-w-3xl mx-auto group">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 select-none"
                                :class="msg.role === 'user' ? 'bg-blue-600' : 'bg-green-600'">
                                <span class="text-xs font-bold">{{ msg.role === 'user' ? 'U' : 'AI' }}</span>
                            </div>
                            <div class="flex-1 min-w-0 space-y-2">
                                <div v-if="msg.reasoning_content" class="mb-2">
                                    <details class="group/thinking bg-[#0d1117] rounded-lg border border-blue-900/30 overflow-hidden">
                                        <summary class="px-3 py-2 cursor-pointer bg-[#161b22] hover:bg-[#1c2128] transition select-none flex items-center gap-2 text-xs text-gray-400 font-medium list-none">
                                            <svg class="w-3 h-3 text-gray-500 transition-transform group-open/thinking:rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                            <span class="text-blue-400">Thinking Process</span>
                                            <span v-if="!msg.done && msg.role === 'assistant'" class="animate-pulse">...</span>
                                        </summary>
                                        <div class="p-3 text-gray-400 text-xs font-mono whitespace-pre-wrap border-t border-[#30363d] bg-[#0d1117]/50 leading-relaxed">
                                            {{ msg.reasoning_content }}
                                        </div>
                                    </details>
                                </div>

                                <div class="bg-[#161b22] rounded-lg p-3 border border-[#30363d] text-gray-200 text-sm leading-relaxed shadow-sm relative">
                                    <div v-if="msg.role === 'assistant'" class="prose" v-html="renderMarkdown(msg.content)"></div>
                                    <div v-else class="whitespace-pre-wrap">{{ msg.content }}</div>
                                </div>

                                <div v-if="msg.images && msg.images.length" class="flex gap-2 flex-wrap">
                                    <img v-for="(img, i) in msg.images" :key="i" :src="img" class="h-24 w-auto rounded-md border border-[#30363d] object-cover cursor-pointer hover:opacity-80 transition" @click="showImage(img)">
                                </div>
                            </div>
                        </div>
                        <div v-if="isSending" class="flex gap-4 max-w-3xl mx-auto">
                            <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center shrink-0 animate-pulse">
                                <span class="text-xs font-bold">...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-[#30363d] bg-[#161b22]">
                        <div class="max-w-3xl mx-auto space-y-3">
                            <div v-if="pendingImages.length" class="flex gap-2 overflow-x-auto pb-2">
                                <div v-for="(img, idx) in pendingImages" :key="idx" class="relative group">
                                    <img :src="img.preview" class="h-16 w-16 rounded object-cover border border-[#30363d]">
                                    <button @click="pendingImages.splice(idx, 1)" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">×</button>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="$refs.fileInput.click()" class="px-3 py-2 bg-[#21262d] text-gray-400 hover:text-white rounded border border-[#30363d] transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </button>
                                <input type="file" ref="fileInput" class="hidden" multiple accept="image/*" @change="handleImageSelect">
                                <textarea v-model="chatInput" @keydown.ctrl.enter="sendMessage" :placeholder="t('chat.placeholder')"
                                    class="flex-1 bg-[#0d1117] border border-[#30363d] rounded p-2 text-white text-sm focus:border-blue-500 focus:outline-none resize-none h-[42px] max-h-[200px]"></textarea>
                                <button v-if="!isSending" @click="sendMessage" :disabled="(!chatInput.trim() && !pendingImages.length)"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded font-medium transition">
                                    {{ t('chat.send') }}
                                </button>
                                <button v-else @click="stopGeneration"
                                    class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded font-medium transition flex items-center gap-2">
                                    <svg class="w-4 h-4 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    {{ t('chat.stop') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="w-64 bg-[#161b22] border-l border-[#30363d] flex flex-col overflow-auto p-4 space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">{{ t('chat.systemPrompt') }}</label>
                        <textarea v-model="chatConfig.systemPrompt" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white h-24 resize-none focus:border-blue-500 focus:outline-none mb-1" placeholder="You are a helpful AI assistant..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">{{ t('chat.endpoint') }}</label>
                        <input v-model="chatConfig.endpoint" type="text" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white mb-1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">{{ t('chat.apiKey') }}</label>
                        <input v-model="chatConfig.apiKey" type="password" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">{{ t('chat.model') }}</label>
                        <div class="relative">
                            <select v-model="chatConfig.model" @click="fetchModels" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white appearance-none focus:border-blue-500 focus:outline-none">
                                <option v-for="m in availableModels" :key="m.id" :value="m.id">{{ m.display_name || m.id }}</option>
                                <option value="custom">{{ t('chat.customModel') }}</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        <input v-if="chatConfig.model === 'custom'" v-model="chatConfig.customModel" type="text" class="mt-2 w-full bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white" placeholder="Enter model ID...">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1 items-center">
                            <label class="text-xs font-bold text-gray-500 uppercase">{{ t('chat.temperature') }}</label>
                            <input v-model.number="chatConfig.temperature" type="number" min="0" max="2" step="0.1" class="w-12 bg-transparent text-right text-xs text-blue-400 border-b border-gray-700 focus:border-blue-500 focus:outline-none">
                        </div>
                        <input v-model.number="chatConfig.temperature" type="range" min="0" max="2" step="0.1" class="w-full accent-blue-600 h-1 bg-[#30363d] rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1 items-center">
                            <label class="text-xs font-bold text-gray-500 uppercase">{{ t('chat.topP') }}</label>
                            <input v-model.number="chatConfig.top_p" type="number" min="0" max="1" step="0.05" class="w-12 bg-transparent text-right text-xs text-blue-400 border-b border-gray-700 focus:border-blue-500 focus:outline-none">
                        </div>
                        <input v-model.number="chatConfig.top_p" type="range" min="0" max="1" step="0.05" class="w-full accent-blue-600 h-1 bg-[#30363d] rounded-lg appearance-none cursor-pointer">
                    </div>
                     <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-bold text-gray-500 uppercase">{{ t('chat.maxTokens') }}</label>
                            <span class="text-xs text-blue-400">{{ chatConfig.max_tokens }}</span>
                        </div>
                        <input v-model.number="chatConfig.max_tokens" type="number" class="w-full bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-bold text-gray-500 uppercase">{{ t('chat.googleSearch') }}</label>
                        <div class="relative inline-block w-8 h-4 align-middle select-none transition duration-200 ease-in">
                            <input v-model="chatConfig.googleSearch" type="checkbox" name="toggle" id="googleSearchToggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out" :class="chatConfig.googleSearch ? 'translate-x-4 border-blue-600' : 'translate-x-0 border-gray-400'"/>
                            <label for="googleSearchToggle" class="toggle-label block overflow-hidden h-4 rounded-full cursor-pointer transition-colors duration-200 ease-in-out" :class="chatConfig.googleSearch ? 'bg-blue-600' : 'bg-gray-700'"></label>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-[#30363d]">
                        <button @click="chatMessages = []" class="w-full py-2 border border-[#30363d] hover:bg-red-900/20 text-red-400 rounded text-xs transition">{{ t('chat.clear') }}</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Prompt Modal -->
        <div v-if="currentPrompt" class="modal-overlay">
            <div class="bg-[#161b22] border border-[#30363d] rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
                <h3 class="text-lg font-bold text-white mb-4">{{ currentPrompt.text }}</h3>
                <div v-if="currentPrompt.type === 'choice'" class="space-y-2">
                    <button v-for="opt in currentPrompt.options" :key="opt.value" @click="sendPromptResponse(opt.value)"
                        class="w-full text-left px-4 py-2 rounded-md transition bg-[#21262d] hover:bg-blue-600 text-gray-300 hover:text-white">
                        {{ opt.label }}
                    </button>
                </div>
                <div v-if="currentPrompt.type === 'confirm'">
                    <button @click="sendPromptResponse(currentPrompt.response_value)"
                        class="w-full px-4 py-2 rounded-md transition bg-blue-600 hover:bg-blue-500 text-white font-bold">
                        {{ currentPrompt.confirm_text || 'Confirm' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed, watch, nextTick } = Vue;

        createApp({
            setup() {
                const { lang, t, setLang, availableLangs } = useI18n(ref);
                const currentTab = ref('dashboard');
                const serviceStatus = ref('stopped');
                const serviceInfo = ref({});
                const logs = ref([]);
                const config = ref({});
                const authData = ref({ active: null, saved: [] });
                const loading = ref(false);
                const autoScroll = ref(true);
                const logsContainer = ref(null);
                const multiPortResults = ref([]);
                const logFilter = ref('ALL');
                const isActionRequired = ref(false);
                const customInput = ref('');
                const currentPrompt = ref(null); // Kept for backward compatibility or future specific prompts
                let ws = null;

                const chatMessages = ref([]);
                const chatInput = ref('');
                const pendingImages = ref([]);
                const isSending = ref(false);
                const chatContainer = ref(null);
                const availableModels = ref([]);
                const chatConfig = ref({
                    endpoint: `http://${window.location.hostname}:2048/v1/chat/completions`,
                    apiKey: 'any',
                    model: '',
                    customModel: '',
                    systemPrompt: ``,
                    temperature: 0.7,
                    top_p: 0.98,
                    max_tokens: 65535,
                    googleSearch: true
                });
                let abortController = null;

                const effectiveModel = computed(() => {
                    return chatConfig.value.model === 'custom' ? chatConfig.value.customModel : chatConfig.value.model;
                });

                const filteredLogs = computed(() => {
                    if (logFilter.value === 'ALL') return logs.value;
                    return logs.value.filter(l => l.level === logFilter.value);
                });

                const statusColor = computed(() => {
                    switch(serviceStatus.value) {
                        case 'running': return 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]';
                        case 'starting': return 'bg-yellow-500 animate-pulse';
                        case 'stopping': return 'bg-red-400 animate-pulse';
                        default: return 'bg-gray-600';
                    }
                });

                const statusTextColor = computed(() => {
                    switch(serviceStatus.value) {
                        case 'running': return 'text-green-400';
                        case 'starting': return 'text-yellow-400';
                        case 'stopping': return 'text-red-400';
                        default: return 'text-gray-500';
                    }
                });

                const connectWS = () => {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    ws = new WebSocket(`${protocol}//${window.location.host}/ws/logs`);
                    
                    let scrollTimeout = null;
                    const scheduleScroll = () => {
                        if (!autoScroll.value) return;
                        if (scrollTimeout) return;
                        scrollTimeout = requestAnimationFrame(() => {
                            if (logsContainer.value) {
                                logsContainer.value.scrollTop = logsContainer.value.scrollHeight;
                            }
                            scrollTimeout = null;
                        });
                    };

                    const handleLogEntry = (entry) => {
                        if (entry.level === 'ACTION_REQUIRED') {
                            isActionRequired.value = true;
                        }
                        logs.value.push(entry);
                        if (logs.value.length > 2000) logs.value.shift();
                        scheduleScroll();
                    };

                    const handleLogBatch = (entries) => {
                        const hasActionRequired = entries.some(e => e.level === 'ACTION_REQUIRED');
                        if (hasActionRequired) {
                            isActionRequired.value = true;
                        }
                        logs.value.push(...entries);
                        if (logs.value.length > 2000) {
                            logs.value = logs.value.slice(-2000);
                        }
                        scheduleScroll();
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.type === 'status') {
                                serviceStatus.value = data.status;
                                serviceInfo.value = data.info || {};
                                if (data.status === 'stopped' || data.status === 'stopping') {
                                    isActionRequired.value = false;
                                }
                            } else if (data.type === 'log') {
                                handleLogEntry(data);
                            } else if (data.type === 'log_batch') {
                                if (data.entries && Array.isArray(data.entries)) {
                                    handleLogBatch(data.entries);
                                }
                            } else if (data.type === 'prompt') {
                                 currentPrompt.value = data.data;
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    };

                    ws.onclose = () => {
                        setTimeout(connectWS, 2000);
                    };
                };

                const fetchConfig = async () => {
                    const res = await fetch('/api/config');
                    config.value = await res.json();
                };

                const saveConfig = async () => {
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(config.value)
                    });
                };

                const fetchAuthFiles = async () => {
                    const res = await fetch('/api/auth/files');
                    authData.value = await res.json();
                };

                const activateAuth = async (filename) => {
                    await fetch('/api/auth/activate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ filename })
                    });
                    await fetchAuthFiles();
                };

                const deactivateAuth = async () => {
                    if(!confirm('确定要取消激活当前认证文件吗？')) return;
                    try {
                        const res = await fetch('/api/auth/deactivate', { method: 'POST' });
                        const data = await res.json();
                        if (!data.success) {
                            alert('操作失败: ' + (data.detail || '未知错误'));
                        } else {
                            await fetchAuthFiles();
                        }
                    } catch (e) {
                        alert('请求发生错误: ' + e);
                    }
                };

                const startService = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch('/api/control/start', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(config.value)
                        });
                        const data = await res.json();
                        if (!data.success) alert(data.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const stopService = async () => {
                    loading.value = true;
                    try {
                        await fetch('/api/control/stop', { method: 'POST' });
                    } finally {
                        loading.value = false;
                    }
                };

                const clearLogs = () => {
                    logs.value = [];
                };

                const checkAllPorts = async () => {
                    const res = await fetch('/api/system/ports');
                    multiPortResults.value = await res.json();
                };

                watch(currentTab, (val) => {
                    if (val === 'system') checkAllPorts();
                });
                
                const fetchModels = async () => {
                    try {
                        const port = config.value.fastapi_port || 2048;
                        const protocol = window.location.protocol;
                        const hostname = window.location.hostname;
                        const modelsEndpoint = `${protocol}//${hostname}:${port}/v1/models`;

                        availableModels.value = [{ id: '', display_name: '加载中...' }];

                        const res = await fetch(modelsEndpoint);

                        if (res.ok) {
                            const data = await res.json();
                            const models = data.data || [];
                            if (models.length > 0) {
                                availableModels.value = models;
                                const currentModelExists = models.some(m => m.id === chatConfig.value.model);
                                if (!chatConfig.value.model || !currentModelExists) {
                                    chatConfig.value.model = models[0].id;
                                }
                            } else {
                                availableModels.value = [{ id: '', display_name: '无可用模型' }];
                            }
                        } else {
                             availableModels.value = [{ id: '', display_name: '加载失败' }];
                        }
                    } catch (e) {
                        console.error("Fetch models failed:", e);
                        availableModels.value = [{ id: '', display_name: '加载失败' }];
                    }
                };

                onMounted(() => {
                    connectWS();
                    fetchConfig();
                    fetchAuthFiles();
                    fetchModels();
                });

                const sendInput = async (value) => {
                    if (serviceStatus.value !== 'running' && serviceStatus.value !== 'starting') return;
                    try {
                        await fetch('/api/control/stdin', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ input: value })
                        });
                        customInput.value = ''; // 发送后清空输入框
                        isActionRequired.value = false; // 乐观地隐藏面板，等待下一个提示
                    } catch (e) {
                        console.error("Failed to send input:", e);
                    }
                };

                const sendPromptResponse = (value) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'prompt_response',
                            value: value
                        }));
                        currentPrompt.value = null;
                    }
                };

                return {
                    lang,
                    t,
                    setLang,
                    availableLangs,
                    currentTab,
                    serviceStatus,
                    serviceInfo,
                    statusColor,
                    statusTextColor,
                    logs,
                    config,
                    authData,
                    loading,
                    autoScroll,
                    logsContainer,
                    saveConfig,
                    activateAuth,
                    deactivateAuth,
                    startService,
                    stopService,
                    clearLogs,
                    logFilter,
                    filteredLogs,
                    multiPortResults,
                    checkAllPorts,
                    isActionRequired,
                    customInput,
                    sendInput,
                    killProcess: async (pid) => {
                        if(!confirm(`确定要强制终止进程 ${pid} 吗？`)) return;
                        const res = await fetch(`/api/system/kill/${pid}`, { method: 'POST' });
                        const data = await res.json();
                        if(data.success) {
                            await fetch('/api/system/ports');
                        } else {
                            alert(data.detail || 'Failed');
                        }
                    },
                    chatMessages, chatInput, pendingImages, isSending, chatContainer, chatConfig, availableModels,
                    fetchModels,
                    stopGeneration: () => {
                        if (abortController) {
                            abortController.abort();
                            abortController = null;
                            isSending.value = false;
                            const lastMsg = chatMessages.value[chatMessages.value.length - 1];
                            if (lastMsg && lastMsg.role === 'assistant') {
                                lastMsg.content += "\n\n[已停止生成]";
                                lastMsg.done = true;
                            }
                        }
                    },
                    renderMarkdown: (text) => {
                        if (!text) return '';
                        try {
                            return marked.parse(text);
                        } catch (e) {
                            return text;
                        }
                    },
                    handleImageSelect: (e) => {
                        const files = Array.from(e.target.files);
                        files.forEach(file => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                pendingImages.value.push({
                                    file: file,
                                    preview: e.target.result,
                                    base64: e.target.result.split(',')[1],
                                    mime: file.type
                                });
                            };
                            reader.readAsDataURL(file);
                        });
                        e.target.value = '';
                    },
                    sendMessage: async () => {
                        if (isSending.value) return;
                        if (!chatInput.value.trim() && pendingImages.value.length === 0) return;

                        const content = [];
                        if (chatInput.value.trim()) {
                            content.push({ type: 'text', text: chatInput.value });
                        }
                        pendingImages.value.forEach(img => {
                            content.push({
                                type: 'image_url',
                                image_url: { url: `data:${img.mime};base64,${img.base64}` }
                            });
                        });

                        const userMsg = {
                            role: 'user',
                            content: chatInput.value,
                            images: pendingImages.value.map(i => i.preview)
                        };
                        
                        chatMessages.value.push(userMsg);
                        
                        const messagesPayload = chatMessages.value.slice(0, -1).map(m => {
                             return { role: m.role, content: m.content };
                        });
                        
                        if (chatConfig.value.systemPrompt && chatConfig.value.systemPrompt.trim()) {
                            messagesPayload.unshift({ role: 'system', content: chatConfig.value.systemPrompt });
                        }
                        
                        messagesPayload.push({ role: 'user', content: content });

                        chatInput.value = '';
                        pendingImages.value = [];
                        isSending.value = true;
                        abortController = new AbortController();

                        nextTick(() => {
                            if(chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                        });

                        try {
                            const payload = {
                                model: effectiveModel.value,
                                messages: messagesPayload,
                                temperature: chatConfig.value.temperature,
                                top_p: chatConfig.value.top_p,
                                max_tokens: chatConfig.value.max_tokens,
                                stream: true
                            };

                            if (chatConfig.value.googleSearch) {
                                payload.tools = [{ "type": "function", "function": { "name": "google_search" } }];
                            }

                            const res = await fetch(chatConfig.value.endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${chatConfig.value.apiKey}`
                                },
                                body: JSON.stringify(payload),
                                signal: abortController.signal
                            });

                            if (!res.ok) throw new Error(`API Error: ${res.status} ${await res.text()}`);

                            const reader = res.body.getReader();
                            const decoder = new TextDecoder();
                            let aiMsg = { role: 'assistant', content: '', reasoning_content: '', done: false };
                            chatMessages.value.push(aiMsg);

                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) {
                                    aiMsg.done = true;
                                    break;
                                }
                                
                                const chunk = decoder.decode(value, { stream: true });
                                const lines = chunk.split('\n');
                                
                                for (const line of lines) {
                                    if (line.startsWith('data: ') && line.trim() !== 'data: [DONE]') {
                                        try {
                                            const jsonStr = line.slice(6);
                                            if (jsonStr) {
                                                const data = JSON.parse(jsonStr);
                                                const choice = data.choices && data.choices[0];
                                                if (choice) {
                                                    const delta = choice.delta;
                                                    if (delta.content) {
                                                        aiMsg.content += delta.content;
                                                    }
                                                    if (delta.reasoning_content) {
                                                        aiMsg.reasoning_content += delta.reasoning_content;
                                                    }
                                                    nextTick(() => {
                                                        if(chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                                                    });
                                                }
                                            }
                                        } catch (e) {
                                            console.error('Error parsing stream chunk:', e, 'Chunk:', line);
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            if (e.name === 'AbortError') {
                                console.log('Request aborted by user');
                            } else {
                                const lastMsg = chatMessages.value[chatMessages.value.length-1];
                                if(lastMsg && lastMsg.role === 'assistant'){
                                   lastMsg.content = `Error: ${e.message}`;
                                } else {
                                   chatMessages.value.push({ role: 'assistant', content: `Error: ${e.message}` });
                                }
                            }
                        } finally {
                            isSending.value = false;
                            abortController = null;
                        }
                    },
                    showImage: (src) => {
                        const w = window.open("");
                        w.document.write(`<img src="${src}" style="max-width:100%">`);
                    },
                    currentPrompt, // Expose prompt state
                    sendPromptResponse // Expose prompt response handler
                };
            },
        }).mount('#app');
    </script>
</body>
</html>